<sequence xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" disabled="false" id="9d1e8764-7699-4e2c-b520-c79bf5b696e8">
	<steps xsi:type="be.nabu.libs.services.vm.step.Map" disabled="false" comment="Get user by alias and realm" id="98106c59-1eb3-4c28-b7ee-279c423fa756">
		<steps xsi:type="be.nabu.libs.services.vm.step.Invoke" disabled="false" id="7f59a6fa-1ff8-4be9-84e9-4a08de9259db" serviceId="nabu.cms.core.database.user.selectActiveByAlias" resultName="resultcfd7cf9945214080ad3933aa19952744" temporaryMapping="true" invocationOrder="0" y="23" x="66">
			<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="4f771339-fbc1-42e5-8772-e2af65fe6849" optional="false" mask="false" fixedValue="false">
				<from>input/credentials/name</from>
				<to>parameters/alias</to>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="cfff3adf-2c34-4af0-afa3-cbbccbb162a4" optional="false" mask="false" fixedValue="false">
				<from>input/realm</from>
				<to>parameters/realm</to>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="3df892d6-e980-406b-921e-0509763f0425" optional="false" mask="false" fixedValue="false">
				<from>input/configuration/connectionId</from>
				<to>connection</to>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="911db7fb-a767-4f19-8c9f-bb99b9b90594" optional="false" mask="false" fixedValue="false">
				<from>input/configuration/caseInsensitive</from>
				<to>parameters/caseInsensitive</to>
			</steps>
			<asynchronous>false</asynchronous>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="3bc8496d-9b40-4fd6-91f4-5463df86ed90" optional="false" mask="false" fixedValue="false">
			<from>resultcfd7cf9945214080ad3933aa19952744/results[0]</from>
			<to>user</to>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Invoke" disabled="false" id="673538ad-97f7-45eb-80f9-5200a34fbd0f" serviceId="nabu.cms.core.utils.initializeConfiguration" resultName="result6858e05795934ef9b13956418718ccdd" temporaryMapping="true" invocationOrder="0" y="151" x="341">
			<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="8f110395-7a86-4335-b5f1-9eeb72ac94db" optional="false" mask="false" fixedValue="false">
				<from>input/configuration</from>
				<to>configuration</to>
			</steps>
			<asynchronous>false</asynchronous>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="63d7ad3e-3053-441e-b74b-e6a4ca93a22f" optional="false" mask="false" fixedValue="false">
			<from>result6858e05795934ef9b13956418718ccdd/configuration</from>
			<to>input/configuration</to>
		</steps>
	</steps>
	<steps xsi:type="be.nabu.libs.services.vm.step.Switch" disabled="false" id="219f5049-da73-443a-8d0d-301b299a306b">
		<steps xsi:type="be.nabu.libs.services.vm.step.Sequence" disabled="false" label="user != null" id="5dd12f91-58eb-4e2b-a786-0d0d789d28c7">
			<steps xsi:type="be.nabu.libs.services.vm.step.Map" disabled="false" id="438b9c40-f669-4b28-850c-b45eb4a64e35">
				<steps xsi:type="be.nabu.libs.services.vm.step.Invoke" disabled="false" id="0dffb2d3-a15a-4a82-b79c-9d9716d36ab9" serviceId="nabu.cms.core.services.node.audit.create" resultName="resultaffff475036f46ca940c8866f23132f5" temporaryMapping="true" invocationOrder="0" y="37" x="39">
					<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="97811928-58a0-4c78-bee3-389ec75bf0ee" optional="false" mask="false" fixedValue="false">
						<from>input/configuration/connectionId</from>
						<to>connectionId</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="89c3e2e7-a427-4448-860d-0a0fefd70c18" optional="false" mask="false" fixedValue="false">
						<from>user/id</from>
						<to>nodeId</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="6a883308-9ae4-4299-846c-bedba486e53c" optional="false" mask="false" fixedValue="true">
						<from>user.authenticate</from>
						<to>action</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="2129dbf6-1ea5-4b36-b4dc-3b8495244f5c" optional="false" mask="false" fixedValue="true">
						<from>password</from>
						<to>description</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="a432f7f1-413c-41d6-b462-2d17412efbb4" optional="false" mask="false" fixedValue="false">
						<from>input/device</from>
						<to>device</to>
					</steps>
					<asynchronous>false</asynchronous>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="f5e6889c-7705-4e17-9844-bd052ff429c7" optional="false" mask="false" fixedValue="false">
					<from>resultaffff475036f46ca940c8866f23132f5/auditId</from>
					<to>auditId</to>
				</steps>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Sequence" disabled="false" id="f3085ae6-4f69-4c10-8ef4-7f5f2fc90e02">
				<steps xsi:type="be.nabu.libs.services.vm.step.Map" disabled="false" comment="Generate hash from user submitted password" id="30f5cd80-cb6f-4896-8213-4d98dac0dee1">
					<steps xsi:type="be.nabu.libs.services.vm.step.Invoke" disabled="false" id="a0e71d77-132b-4351-8890-0a06551a40df" serviceId="nabu.cms.core.utils.security.hashPassword" resultName="result4d5110f9cb634d7bbdb43ff01c4cf3b6" temporaryMapping="true" invocationOrder="0" y="32" x="90">
						<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="181eb852-8269-4f37-af09-228d5fa9f89f" optional="false" mask="false" fixedValue="false">
							<from>input/credentials/password</from>
							<to>password</to>
						</steps>
						<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="6e533082-3baa-44b0-bf66-dda693da17c6" optional="false" mask="false" fixedValue="false">
							<from>user/salt</from>
							<to>salt</to>
						</steps>
						<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="3e1dfd72-f87a-4fe0-ab40-baf5fdeed089" optional="false" mask="false" fixedValue="false">
							<from>user/realm</from>
							<to>realm</to>
						</steps>
						<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="479a1246-903d-40fa-8ba5-69a82e72a57a" optional="false" mask="false" fixedValue="false">
							<from>user/alias</from>
							<to>name</to>
						</steps>
						<asynchronous>false</asynchronous>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="15421998-0980-4b8a-9889-c93d4412edef" optional="false" mask="false" fixedValue="false">
						<from>result4d5110f9cb634d7bbdb43ff01c4cf3b6/hash</from>
						<to>suppliedHash</to>
					</steps>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Switch" disabled="false" id="a606d2c3-713e-498e-a8e4-040bc9fd109b" query="suppliedHash">
					<steps xsi:type="be.nabu.libs.services.vm.step.Sequence" disabled="false" label="user/password" id="4d0a190e-018f-4e6c-81aa-d458580bae67">
						<steps xsi:type="be.nabu.libs.services.vm.step.Switch" disabled="false" id="43ae0ed1-a164-401f-906a-5901df104a18" query="input/device">
							<steps xsi:type="be.nabu.libs.services.vm.step.Switch" disabled="false" label="null" id="e5c01fbc-d825-4cbd-a076-13b9cac8c314" query="input/configuration/allowAnonymousDevices">
								<steps xsi:type="be.nabu.libs.services.vm.step.Throw" disabled="false" label="false" id="25cf060f-09ba-4964-8fb5-eeb384cf06c8" message="No device found and anonymous devices are not allowed" xsi:nil="true"/>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Sequence" disabled="false" id="dc5411b4-0ac6-46f1-8fcb-7dda7588b8db">
								<steps xsi:type="be.nabu.libs.services.vm.step.Map" disabled="false" comment="Get user devices" id="8d9f3a30-36ad-4601-a49c-8c09a3eec770">
									<steps xsi:type="be.nabu.libs.services.vm.step.Invoke" disabled="false" id="3b707215-2a67-45b7-bf47-7e2fd7504b66" serviceId="nabu.cms.core.services.user.device.getForUser" resultName="result590e55c257a24da4a1b279a26822c271" temporaryMapping="true" invocationOrder="0" y="238" x="53">
										<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="8523098a-8488-4d2f-8dff-1de4af7a80cc" optional="false" mask="false" fixedValue="false">
											<from>input/configuration/connectionId</from>
											<to>connectionId</to>
										</steps>
										<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="ff6d5c38-11fc-40c1-bc1c-d93aa780c9a6" optional="false" mask="false" fixedValue="false">
											<from>user/id</from>
											<to>userId</to>
										</steps>
										<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="a9e62e61-f88c-4c39-87b2-cc48f2dc25a9" optional="false" mask="false" fixedValue="false">
											<from>input/device</from>
											<to>device</to>
										</steps>
										<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="d5f13717-3826-444b-b522-b21a111dd0e7" optional="false" mask="false" fixedValue="false">
											<from>input/configuration/maxAmountOfDevices</from>
											<to>maxAmountOfDevices</to>
										</steps>
										<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="8406eec7-791d-4cf3-a420-2d73476ba604" optional="false" mask="false" fixedValue="false">
											<from>input/configuration/allowNewDevices</from>
											<to>allowNewDevices</to>
										</steps>
										<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="f91e8f23-a587-4c7d-a7af-f8f787a7a8c1" optional="false" mask="false" fixedValue="false">
											<from>input/configuration/implementations/sendDeviceVerification</from>
											<to>sendDeviceVerificationService</to>
										</steps>
										<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="81d9dcc6-f594-437f-8cee-50afed184155" optional="false" mask="false" fixedValue="false">
											<from>auditId</from>
											<to>auditId</to>
										</steps>
										<asynchronous>false</asynchronous>
									</steps>
									<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="5d5d7731-c379-48c4-8ef4-0ae7ce8e68ac" optional="false" mask="false" fixedValue="false">
										<from>result590e55c257a24da4a1b279a26822c271/device</from>
										<to>currentDevice</to>
									</steps>
								</steps>
								<steps xsi:type="be.nabu.libs.services.vm.step.Switch" disabled="false" id="ac17d500-deed-460d-8146-253b3daa4c59" query="currentDevice/allowed">
									<steps xsi:type="be.nabu.libs.services.vm.step.Throw" disabled="false" label="false" id="7c6d17f3-b369-482f-bc3b-8e97367289ce" message="Device not allowed">
										<code>CMS-AUTH-3</code>
									</steps>
								</steps>
								<steps xsi:type="be.nabu.libs.services.vm.step.Switch" disabled="false" label="input/configuration/allowRemember" id="5dc5b809-3448-4a89-b452-2c0a4b47d9d2">
									<steps xsi:type="be.nabu.libs.services.vm.step.Map" disabled="false" label="true" comment="Create a new secret" id="6269502b-4424-4381-a81a-a839b10bcea6">
										<steps xsi:type="be.nabu.libs.services.vm.step.Invoke" disabled="false" id="1715ceea-8a8a-4bba-9017-e7fdbac2509e" serviceId="nabu.utils.Server.uuid" resultName="result26d815b27f2841abb5ffb04fa433090b" temporaryMapping="true" invocationOrder="0" y="19" x="23">
											<asynchronous>false</asynchronous>
										</steps>
										<steps xsi:type="be.nabu.libs.services.vm.step.Invoke" disabled="false" id="51c836b7-ee80-4856-bb80-70fc7013dbd3" serviceId="nabu.utils.Date.now" resultName="result9eccbba9a94a4604a93003e7ed7f0591" temporaryMapping="true" invocationOrder="0" y="371" x="51">
											<asynchronous>false</asynchronous>
										</steps>
										<steps xsi:type="be.nabu.libs.services.vm.step.Invoke" disabled="false" id="d9c1864e-3df5-44fc-98a8-351f941feb80" serviceId="nabu.cms.core.utils.security.hashPassword" resultName="result0604e9e04b224b89a8c67de161d2de96" temporaryMapping="true" invocationOrder="1" y="154" x="69">
											<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="df174e94-e4f9-43ca-a7c9-aead67ea92ec" optional="false" mask="false" fixedValue="false">
												<from>input/realm</from>
												<to>realm</to>
											</steps>
											<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="8aab8a8f-f64c-43f8-9f93-954e377d478d" optional="false" mask="false" fixedValue="false">
												<from>result26d815b27f2841abb5ffb04fa433090b/uuid</from>
												<to>password</to>
											</steps>
											<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="b497ae47-ac33-446d-9ae7-9a10e7b28a89" optional="false" mask="false" fixedValue="false">
												<from>user/salt</from>
												<to>salt</to>
											</steps>
											<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="9847682d-a2e6-4c45-89b8-10238250ef5c" optional="false" mask="false" fixedValue="false">
												<from>user/alias</from>
												<to>name</to>
											</steps>
											<asynchronous>false</asynchronous>
										</steps>
										<steps xsi:type="be.nabu.libs.services.vm.step.Invoke" disabled="false" id="bcb36d52-b876-4705-ba59-231617fb6bdd" serviceId="nabu.cms.core.database.user.device.update" resultName="result7206ef39f233433fa8e594dea2ce81fa" temporaryMapping="true" invocationOrder="2" y="344" x="317">
											<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="cdfb10ee-90e8-4637-9525-b3fa95f3ebb7" optional="false" mask="false" fixedValue="false">
												<from>input/configuration/connectionId</from>
												<to>connection</to>
											</steps>
											<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="ad208c7b-50fe-4217-9a4e-985fd677c4c8" optional="false" mask="false" fixedValue="false">
												<from>currentDevice/id</from>
												<to>parameters[0]/id</to>
											</steps>
											<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="8b0b50fb-0d81-4cc4-83c2-54703bfd09cf" optional="false" mask="false" fixedValue="false">
												<from>result9eccbba9a94a4604a93003e7ed7f0591/date</from>
												<to>parameters[0]/modified</to>
											</steps>
											<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="acdce7dd-ea55-4a48-a76a-786e0194fdf8" optional="false" mask="false" fixedValue="false">
												<from>result0604e9e04b224b89a8c67de161d2de96/hash</from>
												<to>parameters[0]/secret</to>
											</steps>
											<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="cc49b68d-0bbb-4209-b68b-b710681923f6" optional="false" mask="false" fixedValue="false">
												<from>result9eccbba9a94a4604a93003e7ed7f0591/date</from>
												<to>parameters[0]/secretModified</to>
											</steps>
											<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="ed047f6a-1129-437a-8172-15bb0f90d127" optional="false" mask="false" fixedValue="false">
												<from>auditId</from>
												<to>transaction</to>
											</steps>
											<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="10d300cd-aecd-43ab-9df8-22ef4c12bdb8" optional="false" mask="false" fixedValue="true">
												<from>false</from>
												<to>trackChanges</to>
											</steps>
											<asynchronous>false</asynchronous>
										</steps>
										<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="ca53a310-2058-4f98-a3d3-c0cc989f5df2" optional="false" mask="false" fixedValue="false">
											<from>result26d815b27f2841abb5ffb04fa433090b/uuid</from>
											<to>secret</to>
										</steps>
									</steps>
								</steps>
							</steps>
						</steps>
						<steps xsi:type="be.nabu.libs.services.vm.step.Map" disabled="false" comment="Map the rest of the token and reset the verification code to prevent further use" id="67ca298c-0a84-410b-8b91-ab236a9aae6e">
							<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="fcb5f0ae-e9c2-4fb8-8b58-1aac62faf165" optional="false" mask="false" fixedValue="false">
								<from>input/credentials</from>
								<to>output/response/credentials[0]</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="5e1ceb84-cfeb-430b-b85c-9b5cfa383545" optional="false" mask="false" fixedValue="false">
								<from>input/realm</from>
								<to>output/response/realm</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="16e0fd82-9566-4632-bf5b-9ff98d0cc116" optional="false" mask="false" fixedValue="false">
								<from>secret</from>
								<to>output/response/secret</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Invoke" disabled="false" id="dc71c328-4454-42be-8fb3-0ec02b4190e8" serviceId="nabu.cms.core.database.user.update" resultName="result5253759fe1574d619bab37cfbc4f07ea" temporaryMapping="true" invocationOrder="1" y="120" x="370">
								<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="d5922997-fbea-4432-a8b2-b1c1e0575af3" optional="false" mask="false" fixedValue="false">
									<from>input/configuration/connectionId</from>
									<to>connection</to>
								</steps>
								<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="a705338d-d169-4ca5-89c2-7b2ef040ffa4" optional="false" mask="false" fixedValue="false">
									<from>user/id</from>
									<to>parameters[0]/id</to>
								</steps>
								<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="eeca6ec6-126a-4cf8-ade1-3d3ffa8d089d" optional="false" mask="false" fixedValue="false">
									<from>result38376dbb411d4e25ac21a269065ff7f5/uuid</from>
									<to>parameters[0]/verificationCode</to>
								</steps>
								<asynchronous>false</asynchronous>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Invoke" disabled="false" id="54fdbb09-28d4-4e2d-b555-3966a2a9a2e1" serviceId="nabu.utils.Server.uuid" resultName="result38376dbb411d4e25ac21a269065ff7f5" temporaryMapping="true" invocationOrder="0" y="320" x="38">
								<asynchronous>false</asynchronous>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="559325b1-5510-4f38-8216-30c12ab46cc5" optional="false" mask="false" fixedValue="false">
								<from>user/alias</from>
								<to>output/response/name</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Invoke" disabled="false" id="5ccbdf83-8140-4c5f-848c-eec39f081b3c" serviceId="nabu.cms.core.database.node.audit.updateActor" resultName="resultae51bbab81a641b081bbd79730b01fc1" temporaryMapping="true" invocationOrder="0" y="430" x="110">
								<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="c4e2e82c-d0f7-4538-9b7e-ee02cdd73499" optional="false" mask="false" fixedValue="false">
									<from>input/configuration/connectionId</from>
									<to>connection</to>
								</steps>
								<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="2640a409-6e81-4b83-a724-491a3ddd27e3" optional="false" mask="false" fixedValue="false">
									<from>auditId</from>
									<to>parameters[0]/id</to>
								</steps>
								<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="b7d362b6-25f3-4a56-a324-4c453ab72b4c" optional="false" mask="false" fixedValue="false">
									<from>user/id</from>
									<to>parameters[0]/actorId</to>
								</steps>
								<asynchronous>false</asynchronous>
							</steps>
						</steps>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Throw" disabled="false" id="67e864c4-3502-45b5-92c0-7f2145fb4010" message="Invalid password">
						<code>CMS-AUTH-1</code>
					</steps>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Catch" disabled="false" id="5a378ab8-0cef-4cfb-b97b-e0197fc449aa" variable="exception">
					<steps xsi:type="be.nabu.libs.services.vm.step.Map" disabled="false" id="e69b3dc1-ce31-4ccd-a217-29b0bee13169">
						<steps xsi:type="be.nabu.libs.services.vm.step.Invoke" disabled="false" id="7544cff1-b2ee-4d72-b277-3b9535f04140" serviceId="nabu.cms.core.services.node.audit.error" resultName="resultf0058a1ba5fc4283b405f086eccb1e80" temporaryMapping="true" invocationOrder="0" y="78" x="33">
							<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="011869f5-da36-464c-8171-6ba66434cb62" optional="false" mask="false" fixedValue="false">
								<from>exception</from>
								<to>exception</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="cdae914c-f6a7-4b52-93f2-4515e9969a34" optional="false" mask="false" fixedValue="false">
								<from>input/configuration/connectionId</from>
								<to>connectionId</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="100ef8b4-68da-4631-b25a-bd8dc38b3ebe" optional="false" mask="false" fixedValue="false">
								<from>auditId</from>
								<to>auditId</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link" disabled="false" id="ee535d8e-4465-4a45-b9e5-5b3486c49ed2" optional="false" mask="false" fixedValue="true">
								<from>false</from>
								<to>rethrow</to>
							</steps>
							<asynchronous>false</asynchronous>
						</steps>
					</steps>
				</steps>
			</steps>
		</steps>
	</steps>
</sequence>