<sequence xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		disabled="false"
		id="9d1e8764-7699-4e2c-b520-c79bf5b696e8">
	<steps xsi:type="be.nabu.libs.services.vm.step.Map"
			disabled="false"
			id="25421546-4e97-4da4-b9c9-b0394fb4b32b"
			label="input/credentials/name != null">
		<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
				disabled="false"
				id="20539cde-ee9b-4508-922f-111f148dc7b4"
				serviceId="nabu.utils.String.trim"
				resultName="result294f09170cce4dde82d82c72c0c5a92b"
				temporaryMapping="true"
				x="98"
				y="69"
				invocationOrder="0"
				asynchronous="false"
				recache="false">
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="aa99e1a5-520b-4c93-bfa6-1ead0b80d747"
					mask="false"
					optional="false"
					fixedValue="false">
				<from>input/credentials/name</from>
				<to>string</to>
			</steps>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Link"
				disabled="false"
				id="504b2ea8-56ec-4951-8f47-a346659ac596"
				mask="false"
				optional="false"
				fixedValue="false">
			<from>result294f09170cce4dde82d82c72c0c5a92b/trimmed</from>
			<to>input/credentials/name</to>
		</steps>
	</steps>
	<steps xsi:type="be.nabu.libs.services.vm.step.Map"
			comment="Initialize configuration"
			disabled="false"
			id="9d22aa5820cd4aadbae2865ac094b263">
		<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
				disabled="false"
				id="a10d7c9fc1c04e19b443a6bf4d7dc32b"
				serviceId="nabu.cms.core.utils.initializeConfiguration"
				resultName="result6858e05795934ef9b13956418718ccdd"
				temporaryMapping="true"
				x="341"
				y="151"
				invocationOrder="0"
				asynchronous="false"
				recache="false">
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="d46a3e9f729847babcaf7a8ac2c260c3"
					mask="false"
					optional="false"
					fixedValue="false">
				<from>input/configuration</from>
				<to>configuration</to>
			</steps>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Link"
				disabled="false"
				id="10e36ddb6f6a49358b9bb12de8a8a388"
				mask="false"
				optional="false"
				fixedValue="false">
			<from>result6858e05795934ef9b13956418718ccdd/configuration</from>
			<to>input/configuration</to>
		</steps>
	</steps>
	<steps xsi:type="be.nabu.libs.services.vm.step.Sequence"
			comment="Try to use temporary authentication"
			disabled="true"
			id="8448fdf6-cb78-42f7-8bfd-80bfb9067a11">
		<steps xsi:type="be.nabu.libs.services.vm.step.Map"
				comment="Get temporary token"
				disabled="false"
				id="5b8517ec-5145-4772-bb1f-b91090219038">
			<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
					disabled="false"
					id="e7d7c83a-d30b-4fd0-83e9-afbf4de08007"
					serviceId="nabu.web.application.Services.temporarilyAuthenticate"
					resultName="resultd7bbfd341ef045e7b1616fde0a385c41"
					temporaryMapping="true"
					x="329"
					y="139"
					invocationOrder="1"
					asynchronous="false"
					recache="false">
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="da6aaa08-cf3a-47ee-b7b2-d35af98a2cdb"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>input/credentials/name</from>
					<to>authentication/id</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="757f7424-25fb-4206-a35e-372ee846e0b7"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>input/credentials/password</from>
					<to>authentication/secret</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="0f8efa44-a9a2-4b3a-ad4d-6f63991b2472"
						mask="false"
						optional="false"
						fixedValue="true">
					<from>authentication</from>
					<to>type</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="fd27a7f5-42bf-4e7a-9dae-f6023e8cb68c"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>input/device</from>
					<to>device</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="8a556027-d1cd-4577-ab62-aea7ca056fae"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>result815b35cc72b8445c9e4db57484ea21fa/serviceContext</from>
					<to>webApplicationId</to>
				</steps>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
					disabled="false"
					id="c92e88be-b360-4670-8482-5912923e5ffc"
					serviceId="nabu.utils.Runtime.getServiceContext"
					resultName="result815b35cc72b8445c9e4db57484ea21fa"
					temporaryMapping="true"
					x="26"
					y="16"
					invocationOrder="0"
					asynchronous="false"
					recache="false">
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="8e40e932-2180-4f1b-9ef3-880fc02bdf7f"
					mask="false"
					optional="false"
					fixedValue="false">
				<from>resultd7bbfd341ef045e7b1616fde0a385c41/response</from>
				<to>temporaryToken</to>
			</steps>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Map"
				comment="Get user by alias and realm"
				disabled="false"
				id="98106c59-1eb3-4c28-b7ee-279c423fa756"
				label="temporaryToken">
			<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
					disabled="false"
					id="7f59a6fa-1ff8-4be9-84e9-4a08de9259db"
					serviceId="nabu.cms.core.database.user.selectActiveByAlias"
					resultName="resultcfd7cf9945214080ad3933aa19952744"
					temporaryMapping="true"
					x="66"
					y="23"
					invocationOrder="0"
					asynchronous="false"
					recache="false">
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="3df892d6-e980-406b-921e-0509763f0425"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>input/configuration/connectionId</from>
					<to>connection</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="911db7fb-a767-4f19-8c9f-bb99b9b90594"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>input/configuration/caseInsensitive</from>
					<to>parameters/caseInsensitive</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="4854ea9a-cf30-496d-b203-fd0efa0de1aa"
						mask="false"
						optional="false"
						fixedValue="true">
					<from>true</from>
					<to>parameters/allowUnverified</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="2c4aecff-cb5d-4e87-b5f4-9fa0e05c5229"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>temporaryToken/name</from>
					<to>parameters/alias</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="82672722-410e-4089-8770-3cce2cbcf536"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>temporaryToken/realm</from>
					<to>parameters/realm</to>
				</steps>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="3bc8496d-9b40-4fd6-91f4-5463df86ed90"
					mask="false"
					optional="false"
					fixedValue="false">
				<from>resultcfd7cf9945214080ad3933aa19952744/results[0]</from>
				<to>user</to>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="a120f3e3-623f-43d2-82d2-d20e26f03140"
					mask="false"
					optional="false"
					fixedValue="false">
				<from>resultcfd7cf9945214080ad3933aa19952744/results[0]</from>
				<to>originalUser</to>
			</steps>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Catch"
				comment="Ignore any exceptions"
				disabled="false"
				id="5b7d636a-5954-4b71-966e-1141666c1183">
		</steps>
	</steps>
	<steps xsi:type="be.nabu.libs.services.vm.step.Map"
			comment="Get user by alias and realm"
			disabled="false"
			id="2c54f40ec03843e7857fd25fc08a5b18"
			label="!user">
		<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
				disabled="false"
				id="351a8880077d4c959a81e9d4c6d92b71"
				serviceId="nabu.cms.core.database.user.selectActiveByAlias"
				resultName="resultcfd7cf9945214080ad3933aa19952744"
				temporaryMapping="true"
				x="66"
				y="23"
				invocationOrder="0"
				asynchronous="false"
				recache="false">
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="6c7e60affde144c49d08e06d34187e18"
					mask="false"
					optional="false"
					fixedValue="false">
				<from>input/credentials/name</from>
				<to>parameters/alias</to>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="c74b9c38bcb64850bf50e43a0b4ccdcc"
					mask="false"
					optional="false"
					fixedValue="false">
				<from>input/realm</from>
				<to>parameters/realm</to>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="34f9b32d5cac4ef090657755f9257b34"
					mask="false"
					optional="false"
					fixedValue="false">
				<from>input/configuration/connectionId</from>
				<to>connection</to>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="c852c2b656f14951bbe40ed40c1abe15"
					mask="false"
					optional="false"
					fixedValue="false">
				<from>input/configuration/caseInsensitive</from>
				<to>parameters/caseInsensitive</to>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="5d76bae557694d2b9e87ce9766e4aafa"
					mask="false"
					optional="false"
					fixedValue="true">
				<from>true</from>
				<to>parameters/allowUnverified</to>
			</steps>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Link"
				disabled="false"
				id="c2c8f246748844cb99acb64cddf2aec4"
				mask="false"
				optional="false"
				fixedValue="false">
			<from>resultcfd7cf9945214080ad3933aa19952744/results[0]</from>
			<to>user</to>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Link"
				disabled="false"
				id="4db5e06331274ba8b1e121d592e3c121"
				mask="false"
				optional="false"
				fixedValue="false">
			<from>resultcfd7cf9945214080ad3933aa19952744/results[0]</from>
			<to>originalUser</to>
		</steps>
	</steps>
	<steps xsi:type="be.nabu.libs.services.vm.step.Sequence"
			comment="Check if it is a phone number"
			disabled="false"
			id="78a3f1c6-61b2-4279-aea7-41c1af0fec78"
			label="!user &amp;&amp; input/configuration/texts/textProviderId != null">
		<steps xsi:type="be.nabu.libs.services.vm.step.Map"
				disabled="false"
				id="25c9755e-0146-4382-9d04-a85e9b112045">
			<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
					disabled="false"
					id="48a4c8f6-41ee-4a98-bc6b-1eff510489ed"
					serviceId="nabu.libs.google.phone.Services.format"
					resultName="result56b0af0c4ff946e2b1c1ae460807b3c8"
					temporaryMapping="true"
					x="193"
					y="75"
					invocationOrder="0"
					asynchronous="false"
					recache="false">
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="c156112e-09d6-4753-8957-119c56a6f6e4"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>input/credentials/name</from>
					<to>number</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="c3074038-b984-463e-9184-6b54d29657a1"
						mask="false"
						optional="false"
						fixedValue="true">
					<from>E164</from>
					<to>format</to>
				</steps>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
					disabled="false"
					id="0a254e95-0c35-464f-813c-591de3caadd6"
					serviceId="nabu.cms.core.database.user.selectActiveByAlias"
					resultName="result8b6970481b1344c7b95640a4291d822f"
					temporaryMapping="true"
					x="561"
					y="145"
					invocationOrder="1"
					asynchronous="false"
					recache="false">
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="383849ae-9edf-47ab-973d-0c7897a06dd0"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>result56b0af0c4ff946e2b1c1ae460807b3c8/formatted</from>
					<to>parameters/alias</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="56219d44-5d0b-492f-9562-1a4d67650ecd"
						mask="false"
						optional="false"
						fixedValue="true">
					<from>true</from>
					<to>parameters/caseInsensitive</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="5cbec87d-b25d-48b5-8ea7-1739c77769c8"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>input/realm</from>
					<to>parameters/realm</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="7b0a7bea-05a3-417c-8de3-a03dda3c3714"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>input/configuration/connectionId</from>
					<to>connection</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="8063d899-8476-486a-b8e9-9b65e349efaa"
						mask="false"
						optional="false"
						fixedValue="true">
					<from>true</from>
					<to>parameters/allowUnverified</to>
				</steps>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="6ccc00a3-41a6-4d11-b421-72a679051cdf"
					mask="false"
					optional="false"
					fixedValue="false">
				<from>result8b6970481b1344c7b95640a4291d822f/results[0]</from>
				<to>user</to>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="c0e81fb1-a066-4a3e-940a-e5496fcf69e4"
					mask="false"
					optional="false"
					fixedValue="false">
				<from>result8b6970481b1344c7b95640a4291d822f/results[0]</from>
				<to>originalUser</to>
			</steps>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Catch"
				comment="We ignore exceptions thrown by the phone parser, we assume it is not a phone number"
				disabled="false"
				id="f1e95ee0-51ae-45ec-afda-f7cbf4374887">
		</steps>
	</steps>
	<steps xsi:type="be.nabu.libs.services.vm.step.Switch"
			comment="Check that the user is not anonymous"
			disabled="false"
			id="6da48c8e-b84c-4d3a-a016-640f7958175d">
		<steps xsi:type="be.nabu.libs.services.vm.step.Switch"
				disabled="false"
				id="4ac1cc50-d1b4-4731-8f2a-ad3943c1143b"
				label="user/anonymous != null &amp;&amp; user/anonymous">
			<steps xsi:type="be.nabu.libs.services.vm.step.Throw"
					description="=&quot;Can not log in with an anonymous account: &quot; + user/alias"
					disabled="false"
					id="102e52eb-7408-4971-83a3-852f3fe2c390"
					label="input/configuration/allowAnonymousLogin == null || !input/configuration/allowAnonymousLogin"
					code="CMS-AUTH-8"
					message="Can not log in with an anonymous account"
					alias="=user/alias"
					realm="=user/realm" xsi:nil="true"/>
		</steps>
	</steps>
	<steps xsi:type="be.nabu.libs.services.vm.step.Sequence"
			disabled="false"
			id="5dd12f91-58eb-4e2b-a786-0d0d789d28c7"
			label="user != null">
		<steps xsi:type="be.nabu.libs.services.vm.step.Map"
				comment="Get the node for the user"
				disabled="false"
				id="e66188b1-e332-40a1-ba16-0065c12c9745">
			<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
					disabled="false"
					id="eb529d8c-1ffe-4557-8cfc-5fc1b2243045"
					serviceId="nabu.cms.core.database.node.selectById"
					resultName="result05f11f577860424da84b25f4e104eb0b"
					temporaryMapping="true"
					x="224"
					y="92"
					invocationOrder="0"
					asynchronous="false"
					recache="false">
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="32ad0223-33d5-4d26-9814-65855b5209f3"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>user/id</from>
					<to>parameters/id</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="467dc839-5683-41ed-9824-1a21f764d243"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>input/configuration/connectionId</from>
					<to>connection</to>
				</steps>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="e5971368-3005-42ac-b755-6828fc1d46e8"
					mask="false"
					optional="false"
					fixedValue="false">
				<from>result05f11f577860424da84b25f4e104eb0b/results[0]</from>
				<to>userNode</to>
			</steps>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Throw"
				description="=&quot;The user &quot; + input/credentials/name + &quot; is not verified yet&quot;"
				disabled="false"
				id="ef39ec82-9c28-4460-9dcf-bc06fa1324b3"
				label="userNode/verified = null"
				code="CMS-AUTH-10"
				message="The user is not verified yet, can not log in"
				alias="=user/alias"
				realm="=user/realm" xsi:nil="true"/>
		<steps xsi:type="be.nabu.libs.services.vm.step.Map"
				comment="If the user is not his own owner, it is an alias account"
				disabled="false"
				id="42260c21-6970-4334-a179-4244e4d42fb7"
				label="userNode/ownerId != null &amp;&amp; userNode/ownerId != userNode/id">
			<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
					disabled="false"
					id="77ff9e55-c383-485d-a8e4-c3da21829aa0"
					serviceId="nabu.cms.core.database.user.selectById"
					resultName="resultd3dd9ec0cba54e51b78e016b3ec12c12"
					temporaryMapping="true"
					x="102"
					y="56"
					invocationOrder="0"
					asynchronous="false"
					recache="false">
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="d2927fa9-8142-4533-933e-38313bf0712a"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>input/configuration/connectionId</from>
					<to>connection</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="241d4d6c-20da-4491-b2bc-70332abfbc87"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>userNode/ownerId</from>
					<to>parameters/id</to>
				</steps>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="0b9f5321-c19e-496d-a59c-4a1282d5afa6"
					mask="false"
					optional="false"
					fixedValue="false">
				<from>resultd3dd9ec0cba54e51b78e016b3ec12c12/results[0]</from>
				<to>user</to>
			</steps>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Throw"
				description="=&quot;Invalid owner for &quot; + input/credentials/name + &quot; in &quot; + input/realm"
				disabled="false"
				id="f143539b-0434-44bd-9727-5ebcc83ebdac"
				label="!user"
				code="CMS-AUTH-6"
				message="Invalid owner"
				alias="=user/alias"
				realm="=user/realm" xsi:nil="true"/>
		<steps xsi:type="be.nabu.libs.services.vm.step.Sequence"
				comment="Check whitelist of roles (if any)"
				disabled="false"
				id="829ea2f1-c594-4c4b-aad6-9b69e0ca0e4d"
				label="input/configuration/security/allowedRoles != null">
			<steps xsi:type="be.nabu.libs.services.vm.step.Map"
					disabled="true"
					id="ce07b8d7-4b06-4356-960c-816f2d1138a0">
				<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
						disabled="false"
						id="b3f1628c-33bd-49eb-bc1b-5203180d0754"
						serviceId="nabu.cms.core.database.user.selectGlobalRolesByAlias"
						resultName="result0d8b9c976df14ff1979528bf952661b4"
						temporaryMapping="true"
						x="33"
						y="51"
						invocationOrder="0"
						asynchronous="false"
						recache="false">
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="b49a2c7a-128f-4999-9717-50c1c1c3d309"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>user/alias</from>
						<to>parameters/alias</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="ec3c9b0d-8ba0-43f1-83d5-d3da0623aad0"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>user/realm</from>
						<to>parameters/realm</to>
					</steps>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="62fc3d4d-9268-4f3b-9be2-d3440e198bad"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>result0d8b9c976df14ff1979528bf952661b4/results</from>
					<to>globalRoles</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="49ffd507-0bf3-4f94-a519-f528469f10f4"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>result0d8b9c976df14ff1979528bf952661b4/results[name # /input/configuration/security/allowedRoles]</from>
					<to>matchingRoles</to>
				</steps>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Map"
					disabled="false"
					id="ed6774eb0f7f43d5a618ccd8a72e07cd">
				<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
						disabled="false"
						id="31cc8f56-f2c6-4f2c-a3f2-2f27264d22ed"
						serviceId="nabu.cms.core.database.user.selectPotentialRolesByAlias"
						resultName="result74a08bf26f1149daa02d4c1adb7d5789"
						temporaryMapping="true"
						x="38"
						y="64"
						invocationOrder="0"
						asynchronous="false"
						recache="false">
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="8317e4dc-6adb-4b97-98cd-92e9d998ad8f"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>user/alias</from>
						<to>parameters/alias</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="53b240c8-6f1a-4210-a152-6d2f493999b0"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>user/realm</from>
						<to>parameters/realm</to>
					</steps>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="73df3447-bf28-4c59-86ac-1086ecc89001"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>result74a08bf26f1149daa02d4c1adb7d5789/results</from>
					<to>globalRoles</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="5c495aa4-20e0-4aa8-9a9e-4fc51cf7901d"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>result74a08bf26f1149daa02d4c1adb7d5789/results[name # /input/configuration/security/allowedRoles]</from>
					<to>matchingRoles</to>
				</steps>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Map"
					comment="Get amount of matches"
					disabled="false"
					id="51c93eea-281b-4ade-be19-3a56b5a46c2a">
				<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
						disabled="false"
						id="00583539-895a-4ee6-a251-906ba3a3a1ee"
						serviceId="nabu.utils.List.size"
						resultName="resultc2899ae04782448ba4fe41478d02fc79"
						temporaryMapping="true"
						x="94"
						y="116"
						invocationOrder="0"
						asynchronous="false"
						recache="false">
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="8ad682e7-da5f-40cb-b5ad-4dbc68c0142e"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>matchingRoles</from>
						<to>list</to>
					</steps>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="40c88ab1-1620-415e-b4b4-1edbf5b4fac3"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>resultc2899ae04782448ba4fe41478d02fc79/size</from>
					<to>amountOfMatchingRoles</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
						disabled="false"
						id="b6b07d05-83ae-4eb0-8bbd-256443c68d39"
						serviceId="nabu.utils.String.join"
						resultName="result455ff03db06f4b6ebba453f300edc438"
						temporaryMapping="true"
						x="70"
						y="191"
						invocationOrder="0"
						asynchronous="false"
						recache="false">
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="ebee67a2-6e30-40c7-b8c4-406125119ea9"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>input/configuration/security/allowedRoles</from>
						<to>parts</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="2258d8e6-c439-486e-a4ee-d1e4e2e96984"
							mask="false"
							optional="false"
							fixedValue="true">
						<from>, </from>
						<to>separator</to>
					</steps>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="73d0c5de-f31f-4b50-bce9-e5774f8d38f7"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>result455ff03db06f4b6ebba453f300edc438/string</from>
					<to>stringifiedAllowedRoles</to>
				</steps>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Throw"
					description="=&quot;User &quot; + user/alias + &quot; does not have one of the following roles: &quot; + stringifiedAllowedRoles"
					disabled="false"
					id="0a07b534-7236-4dd7-a109-d11df327e1da"
					label="amountOfMatchingRoles &lt;= 0"
					code="CMS-AUTH-5"
					message="The user does not have one of the mandated roles"
					alias="=user/alias"
					realm="=user/realm" xsi:nil="true"/>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Sequence"
				disabled="false"
				id="1cf48f79-4f68-43ad-8a5a-71f10dd5d0ef"
				label="input/configuration/security/allowedAliases != null">
			<steps xsi:type="be.nabu.libs.services.vm.step.Map"
					comment="Check if it matches some alias"
					disabled="false"
					id="857cb682-8834-48ca-8f37-5d3cf018f778">
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="02bae7d6-a6d9-4255-bb1c-1bbe1fb89a60"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>input/configuration/security/allowedAliases[/input/credentials/name ~ $this]</from>
					<to>allowedAliases</to>
				</steps>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Map"
					disabled="false"
					id="1285f37c-e6de-4fff-a92f-30e94fb88442">
				<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
						disabled="false"
						id="a2313423-59a9-444b-9472-b53c916e6ce0"
						serviceId="nabu.utils.List.size"
						resultName="result21fbe5fc7629435d8a318a94cbd895ac"
						temporaryMapping="true"
						x="122"
						y="93"
						invocationOrder="0"
						asynchronous="false"
						recache="false">
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="b8050755-c6fe-4c3d-a014-50fd08ab5338"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>allowedAliases</from>
						<to>list</to>
					</steps>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="bb68b521-3af8-4e56-bc1c-0828382fc03b"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>result21fbe5fc7629435d8a318a94cbd895ac/size</from>
					<to>amountOfMatchingAliases</to>
				</steps>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Throw"
					description="=&quot;User &quot; + user/alias + &quot; does not have one of the allowed aliases&quot;"
					disabled="false"
					id="b3bc9217-46ba-43dc-8515-53315363dc45"
					label="amountOfMatchingAliases == 0"
					code="CMS-AUTH-9"
					message="The user is not allowed to log in"
					alias="=user/alias"
					realm="=user/realm" xsi:nil="true"/>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Map"
				disabled="false"
				id="438b9c40-f669-4b28-850c-b45eb4a64e35">
			<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
					disabled="false"
					id="0dffb2d3-a15a-4a82-b79c-9d9716d36ab9"
					serviceId="nabu.cms.core.services.node.audit.create"
					resultName="resultaffff475036f46ca940c8866f23132f5"
					temporaryMapping="true"
					x="39"
					y="37"
					invocationOrder="0"
					asynchronous="false"
					recache="false">
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="97811928-58a0-4c78-bee3-389ec75bf0ee"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>input/configuration/connectionId</from>
					<to>connectionId</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="89c3e2e7-a427-4448-860d-0a0fefd70c18"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>user/id</from>
					<to>nodeId</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="6a883308-9ae4-4299-846c-bedba486e53c"
						mask="false"
						optional="false"
						fixedValue="true">
					<from>user.authenticate</from>
					<to>action</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="2129dbf6-1ea5-4b36-b4dc-3b8495244f5c"
						mask="false"
						optional="false"
						fixedValue="true">
					<from>password</from>
					<to>description</to>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="a432f7f1-413c-41d6-b462-2d17412efbb4"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>input/device</from>
					<to>device</to>
				</steps>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Link"
					disabled="false"
					id="f5e6889c-7705-4e17-9844-bd052ff429c7"
					mask="false"
					optional="false"
					fixedValue="false">
				<from>resultaffff475036f46ca940c8866f23132f5/auditId</from>
				<to>auditId</to>
			</steps>
		</steps>
		<steps xsi:type="be.nabu.libs.services.vm.step.Sequence"
				disabled="false"
				id="f3085ae6-4f69-4c10-8ef4-7f5f2fc90e02">
			<steps xsi:type="be.nabu.libs.services.vm.step.Map"
					comment="Check if the combination is valid"
					disabled="false"
					id="1dfc61c8-60e6-48fb-b8bd-615425fb7853">
				<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
						disabled="false"
						id="bfa43605-414b-4f21-9dfb-f8a72146140e"
						serviceId="nabu.cms.core.utils.security.password.validate"
						resultName="result757a60f37141415b8726b2dc9937aa8d"
						temporaryMapping="true"
						x="92"
						y="68"
						invocationOrder="0"
						asynchronous="false"
						recache="false">
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="1f875aea-c0fb-47ea-a929-e57923ce9c85"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>user/password</from>
						<to>hash</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="1ce3d680-b1de-4302-8679-4b0ffd7e17c2"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>input/credentials/password</from>
						<to>password</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="2705cf55-c575-4a71-9b55-958ca3bcabbc"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>user/salt</from>
						<to>salt</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="5a9eaeb1-0046-405b-a9ea-a28d6fcf92ee"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>user/algorithm</from>
						<to>algorithm</to>
					</steps>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="4b54b55b-be52-49ac-8b1f-7bca13598918"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>result757a60f37141415b8726b2dc9937aa8d/valid</from>
					<to>valid</to>
				</steps>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Map"
					comment="For backwards compatibility reasons, check with the username &amp; realm as well"
					disabled="false"
					id="2d63f4308fe149acbb1e19e4b04aaf24"
					label="!valid">
				<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
						disabled="false"
						id="59353fa479174c25b1539323057fd139"
						serviceId="nabu.cms.core.utils.security.password.validate"
						resultName="result757a60f37141415b8726b2dc9937aa8d"
						temporaryMapping="true"
						x="92"
						y="68"
						invocationOrder="0"
						asynchronous="false"
						recache="false">
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="014eb1bb7e394f6aae7654ff0720387d"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>user/password</from>
						<to>hash</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="5eeee0c0bd5e4a7a984e0b756bd74827"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>input/credentials/password</from>
						<to>password</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="cc9c633e14844db1bd42ebb8313f7871"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>user/salt</from>
						<to>salt</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="c0e48adc-3829-4bc0-aba8-553979eb26cb"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>user/realm</from>
						<to>realm</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="745e77f4-f108-4f05-b02c-2e97bc6c4eb0"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>user/alias</from>
						<to>name</to>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Link"
							disabled="false"
							id="5a8ee6ee-6520-4c3c-968b-44db06390f91"
							mask="false"
							optional="false"
							fixedValue="false">
						<from>user/algorithm</from>
						<to>algorithm</to>
					</steps>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Link"
						disabled="false"
						id="9f6b3c3cfc2d4b348cd2eebecc8d38b5"
						mask="false"
						optional="false"
						fixedValue="false">
					<from>result757a60f37141415b8726b2dc9937aa8d/valid</from>
					<to>valid</to>
				</steps>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Switch"
					disabled="false"
					id="a606d2c3-713e-498e-a8e4-040bc9fd109b"
					query="valid">
				<steps xsi:type="be.nabu.libs.services.vm.step.Sequence"
						disabled="false"
						id="4d0a190e-018f-4e6c-81aa-d458580bae67"
						label="true">
					<steps xsi:type="be.nabu.libs.services.vm.step.Switch"
							comment="Update the password if we updated the algorithm"
							disabled="false"
							id="68ea9f74-3968-498b-94c6-0cdac6ba07e8">
						<steps xsi:type="be.nabu.libs.services.vm.step.Sequence"
								disabled="false"
								id="c4d5c6a2-f732-4417-8188-81d9e88d32bb"
								label="input/configuration/security/algorithm != null &amp;&amp; input/configuration/security/algorithm != user/algorithm">
							<steps xsi:type="be.nabu.libs.services.vm.step.Map"
									comment="Map updated fields"
									disabled="false"
									id="a1e3b26f-eb94-4408-801f-178e1f87714b">
								<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
										disabled="false"
										id="aa29eff4-6e58-4193-afdc-893a87b2804f"
										serviceId="nabu.cms.core.utils.security.password.hash"
										resultName="result24c1f05f96a94657ae596ebc8ed013ba"
										temporaryMapping="true"
										x="203"
										y="82"
										invocationOrder="0"
										asynchronous="false"
										recache="false">
									<steps xsi:type="be.nabu.libs.services.vm.step.Link"
											disabled="false"
											id="7f4804b6-13d9-467d-b33c-3415fe9d5838"
											mask="false"
											optional="false"
											fixedValue="false">
										<from>input/configuration/security/algorithm</from>
										<to>algorithm</to>
									</steps>
									<steps xsi:type="be.nabu.libs.services.vm.step.Link"
											disabled="false"
											id="c87170e3-9cce-47e3-bb87-5ac576dfd0dc"
											mask="false"
											optional="false"
											fixedValue="false">
										<from>input/credentials/password</from>
										<to>password</to>
									</steps>
									<steps xsi:type="be.nabu.libs.services.vm.step.Link"
											disabled="false"
											id="954fd348-cd68-474f-92f4-f2955214a4f9"
											mask="false"
											optional="false"
											fixedValue="false">
										<from>user/salt</from>
										<to>salt</to>
									</steps>
								</steps>
								<steps xsi:type="be.nabu.libs.services.vm.step.Link"
										disabled="false"
										id="b8e44408-8e6f-438f-9a9a-4cd510fe06ef"
										mask="false"
										optional="false"
										fixedValue="false">
									<from>result24c1f05f96a94657ae596ebc8ed013ba/hash</from>
									<to>user/password</to>
								</steps>
								<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
										disabled="false"
										id="48e57620-fe21-4df9-99be-efe1f22c3efc"
										serviceId="nabu.utils.Date.now"
										resultName="result9b2241f6928f44f3ad48b2df4ab3b06f"
										temporaryMapping="true"
										x="276"
										y="293"
										invocationOrder="0"
										asynchronous="false"
										recache="false">
								</steps>
								<steps xsi:type="be.nabu.libs.services.vm.step.Link"
										disabled="false"
										id="946fbd87-9c26-4a48-9706-759caafeca59"
										mask="false"
										optional="false"
										fixedValue="false">
									<from>result9b2241f6928f44f3ad48b2df4ab3b06f/date</from>
									<to>user/modified</to>
								</steps>
								<steps xsi:type="be.nabu.libs.services.vm.step.Link"
										disabled="false"
										id="d0afde65-ad34-49f9-94ce-c985120e886e"
										mask="false"
										optional="false"
										fixedValue="false">
									<from>input/configuration/security/algorithm</from>
									<to>user/algorithm</to>
								</steps>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Map"
									disabled="false"
									id="62bee92b-7fc0-49a2-a166-67a014196f93">
								<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
										disabled="false"
										id="6690d1f0-0361-40e5-9d9e-8808018748b9"
										serviceId="nabu.cms.core.database.user.update"
										resultName="result52356811c3544e1c9ac5ada0c2962cdd"
										temporaryMapping="true"
										x="226"
										y="134"
										invocationOrder="0"
										asynchronous="false"
										recache="false">
									<steps xsi:type="be.nabu.libs.services.vm.step.Link"
											disabled="false"
											id="2e86852a-039d-417f-a9f7-15b6a0de2a5c"
											mask="false"
											optional="false"
											fixedValue="false">
										<from>user</from>
										<to>parameters[0]</to>
									</steps>
									<steps xsi:type="be.nabu.libs.services.vm.step.Link"
											disabled="false"
											id="08e02c30-51a9-4f50-b751-2d0d3d95792b"
											mask="false"
											optional="false"
											fixedValue="false">
										<from>input/configuration/connectionId</from>
										<to>connection</to>
									</steps>
								</steps>
							</steps>
						</steps>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Switch"
							disabled="false"
							id="43ae0ed1-a164-401f-906a-5901df104a18"
							query="input/device">
						<steps xsi:type="be.nabu.libs.services.vm.step.Switch"
								disabled="false"
								id="e5c01fbc-d825-4cbd-a076-13b9cac8c314"
								label="null"
								query="input/configuration/allowAnonymousDevices">
							<steps xsi:type="be.nabu.libs.services.vm.step.Throw"
									disabled="false"
									id="25cf060f-09ba-4964-8fb5-eeb384cf06c8"
									label="false"
									message="No device found and anonymous devices are not allowed"
									alias="=user/alias"
									realm="=user/realm" xsi:nil="true"/>
						</steps>
						<steps xsi:type="be.nabu.libs.services.vm.step.Sequence"
								disabled="false"
								id="dc5411b4-0ac6-46f1-8fcb-7dda7588b8db">
							<steps xsi:type="be.nabu.libs.services.vm.step.Map"
									comment="Get user devices"
									disabled="false"
									id="8d9f3a30-36ad-4601-a49c-8c09a3eec770">
								<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
										disabled="false"
										id="3b707215-2a67-45b7-bf47-7e2fd7504b66"
										serviceId="nabu.cms.core.services.user.device.getForUser"
										resultName="result590e55c257a24da4a1b279a26822c271"
										temporaryMapping="true"
										x="53"
										y="238"
										invocationOrder="0"
										asynchronous="false"
										recache="false">
									<steps xsi:type="be.nabu.libs.services.vm.step.Link"
											disabled="false"
											id="8523098a-8488-4d2f-8dff-1de4af7a80cc"
											mask="false"
											optional="false"
											fixedValue="false">
										<from>input/configuration/connectionId</from>
										<to>connectionId</to>
									</steps>
									<steps xsi:type="be.nabu.libs.services.vm.step.Link"
											disabled="false"
											id="ff6d5c38-11fc-40c1-bc1c-d93aa780c9a6"
											mask="false"
											optional="false"
											fixedValue="false">
										<from>user/id</from>
										<to>userId</to>
									</steps>
									<steps xsi:type="be.nabu.libs.services.vm.step.Link"
											disabled="false"
											id="a9e62e61-f88c-4c39-87b2-cc48f2dc25a9"
											mask="false"
											optional="false"
											fixedValue="false">
										<from>input/device</from>
										<to>device</to>
									</steps>
									<steps xsi:type="be.nabu.libs.services.vm.step.Link"
											disabled="false"
											id="d5f13717-3826-444b-b522-b21a111dd0e7"
											mask="false"
											optional="false"
											fixedValue="false">
										<from>input/configuration/maxAmountOfDevices</from>
										<to>maxAmountOfDevices</to>
									</steps>
									<steps xsi:type="be.nabu.libs.services.vm.step.Link"
											disabled="false"
											id="8406eec7-791d-4cf3-a420-2d73476ba604"
											mask="false"
											optional="false"
											fixedValue="false">
										<from>input/configuration/allowNewDevices</from>
										<to>allowNewDevices</to>
									</steps>
									<steps xsi:type="be.nabu.libs.services.vm.step.Link"
											disabled="false"
											id="f91e8f23-a587-4c7d-a7af-f8f787a7a8c1"
											mask="false"
											optional="false"
											fixedValue="false">
										<from>input/configuration/implementations/sendDeviceVerification</from>
										<to>sendDeviceVerificationService</to>
									</steps>
									<steps xsi:type="be.nabu.libs.services.vm.step.Link"
											disabled="false"
											id="81d9dcc6-f594-437f-8cee-50afed184155"
											mask="false"
											optional="false"
											fixedValue="false">
										<from>auditId</from>
										<to>auditId</to>
									</steps>
								</steps>
								<steps xsi:type="be.nabu.libs.services.vm.step.Link"
										disabled="false"
										id="5d5d7731-c379-48c4-8ef4-0ae7ce8e68ac"
										mask="false"
										optional="false"
										fixedValue="false">
									<from>result590e55c257a24da4a1b279a26822c271/device</from>
									<to>currentDevice</to>
								</steps>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Switch"
									disabled="false"
									id="ac17d500-deed-460d-8146-253b3daa4c59"
									query="currentDevice/allowed">
								<steps xsi:type="be.nabu.libs.services.vm.step.Throw"
										disabled="false"
										id="7c6d17f3-b369-482f-bc3b-8e97367289ce"
										label="false"
										code="CMS-AUTH-3"
										message="Device not allowed"
										alias="=user/alias"
										realm="=user/realm" xsi:nil="true"/>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Switch"
									disabled="false"
									id="5dc5b809-3448-4a89-b452-2c0a4b47d9d2"
									query="input/configuration/allowRemember">
								<steps xsi:type="be.nabu.libs.services.vm.step.Map"
										comment="Create a new secret"
										disabled="false"
										id="6269502b-4424-4381-a81a-a839b10bcea6"
										label="true">
									<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
											disabled="false"
											id="1715ceea-8a8a-4bba-9017-e7fdbac2509e"
											serviceId="nabu.utils.Server.uuid"
											resultName="result26d815b27f2841abb5ffb04fa433090b"
											temporaryMapping="true"
											x="23"
											y="19"
											invocationOrder="0"
											asynchronous="false"
											recache="false">
									</steps>
									<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
											disabled="false"
											id="51c836b7-ee80-4856-bb80-70fc7013dbd3"
											serviceId="nabu.utils.Date.now"
											resultName="result9eccbba9a94a4604a93003e7ed7f0591"
											temporaryMapping="true"
											x="51"
											y="371"
											invocationOrder="0"
											asynchronous="false"
											recache="false">
									</steps>
									<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
											disabled="false"
											id="bcb36d52-b876-4705-ba59-231617fb6bdd"
											serviceId="nabu.cms.core.database.user.device.update"
											resultName="result7206ef39f233433fa8e594dea2ce81fa"
											temporaryMapping="true"
											x="636"
											y="63"
											invocationOrder="2"
											asynchronous="false"
											recache="false">
										<steps xsi:type="be.nabu.libs.services.vm.step.Link"
												disabled="false"
												id="cdfb10ee-90e8-4637-9525-b3fa95f3ebb7"
												mask="false"
												optional="false"
												fixedValue="false">
											<from>input/configuration/connectionId</from>
											<to>connection</to>
										</steps>
										<steps xsi:type="be.nabu.libs.services.vm.step.Link"
												disabled="false"
												id="ad208c7b-50fe-4217-9a4e-985fd677c4c8"
												mask="false"
												optional="false"
												fixedValue="false">
											<from>currentDevice/id</from>
											<to>parameters[0]/id</to>
										</steps>
										<steps xsi:type="be.nabu.libs.services.vm.step.Link"
												disabled="false"
												id="8b0b50fb-0d81-4cc4-83c2-54703bfd09cf"
												mask="false"
												optional="false"
												fixedValue="false">
											<from>result9eccbba9a94a4604a93003e7ed7f0591/date</from>
											<to>parameters[0]/modified</to>
										</steps>
										<steps xsi:type="be.nabu.libs.services.vm.step.Link"
												disabled="false"
												id="cc49b68d-0bbb-4209-b68b-b710681923f6"
												mask="false"
												optional="false"
												fixedValue="false">
											<from>result9eccbba9a94a4604a93003e7ed7f0591/date</from>
											<to>parameters[0]/secretModified</to>
										</steps>
										<steps xsi:type="be.nabu.libs.services.vm.step.Link"
												disabled="false"
												id="ed047f6a-1129-437a-8172-15bb0f90d127"
												mask="false"
												optional="false"
												fixedValue="false">
											<from>auditId</from>
											<to>transaction</to>
										</steps>
										<steps xsi:type="be.nabu.libs.services.vm.step.Link"
												disabled="false"
												id="10d300cd-aecd-43ab-9df8-22ef4c12bdb8"
												mask="false"
												optional="false"
												fixedValue="true">
											<from>false</from>
											<to>trackChanges</to>
										</steps>
										<steps xsi:type="be.nabu.libs.services.vm.step.Link"
												disabled="false"
												id="0bbc4238-35c2-4295-b0fd-8f409e0ff230"
												mask="false"
												optional="false"
												fixedValue="false">
											<from>result59ed73fed314456690f7a4a5e1425c41/hash</from>
											<to>parameters[0]/secret</to>
										</steps>
									</steps>
									<steps xsi:type="be.nabu.libs.services.vm.step.Link"
											disabled="false"
											id="ca53a310-2058-4f98-a3d3-c0cc989f5df2"
											mask="false"
											optional="false"
											fixedValue="false">
										<from>result26d815b27f2841abb5ffb04fa433090b/uuid</from>
										<to>secret</to>
									</steps>
									<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
											disabled="false"
											id="e206fd5e-411c-4e1f-8562-24cdf2bcb141"
											serviceId="nabu.cms.core.utils.security.password.hash"
											resultName="result59ed73fed314456690f7a4a5e1425c41"
											temporaryMapping="true"
											x="248"
											y="154"
											invocationOrder="1"
											asynchronous="false"
											recache="false">
										<steps xsi:type="be.nabu.libs.services.vm.step.Link"
												disabled="false"
												id="7005a4f8-3256-4176-963d-852352a9ed1c"
												mask="false"
												optional="false"
												fixedValue="false">
											<from>result26d815b27f2841abb5ffb04fa433090b/uuid</from>
											<to>password</to>
										</steps>
										<steps xsi:type="be.nabu.libs.services.vm.step.Link"
												disabled="false"
												id="e563f397-00df-476c-b21d-d357071cfc4b"
												mask="false"
												optional="false"
												fixedValue="false">
											<from>user/salt</from>
											<to>salt</to>
										</steps>
										<steps xsi:type="be.nabu.libs.services.vm.step.Link"
												disabled="false"
												id="a495e9e1-e03c-4e04-a96a-a0cc372daf1b"
												mask="false"
												optional="false"
												fixedValue="false">
											<from>user/algorithm</from>
											<to>algorithm</to>
										</steps>
									</steps>
								</steps>
							</steps>
						</steps>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Map"
							comment="Map the rest of the token and reset the verification code to prevent further use"
							disabled="false"
							id="67ca298c-0a84-410b-8b91-ab236a9aae6e">
						<steps xsi:type="be.nabu.libs.services.vm.step.Link"
								disabled="false"
								id="fcb5f0ae-e9c2-4fb8-8b58-1aac62faf165"
								mask="false"
								optional="false"
								fixedValue="false">
							<from>input/credentials</from>
							<to>output/response/credentials[0]</to>
						</steps>
						<steps xsi:type="be.nabu.libs.services.vm.step.Link"
								disabled="false"
								id="5e1ceb84-cfeb-430b-b85c-9b5cfa383545"
								mask="false"
								optional="false"
								fixedValue="false">
							<from>input/realm</from>
							<to>output/response/realm</to>
						</steps>
						<steps xsi:type="be.nabu.libs.services.vm.step.Link"
								disabled="false"
								id="16e0fd82-9566-4632-bf5b-9ff98d0cc116"
								mask="false"
								optional="false"
								fixedValue="false">
							<from>secret</from>
							<to>output/response/secret</to>
						</steps>
						<steps xsi:type="be.nabu.libs.services.vm.step.Link"
								disabled="false"
								id="559325b1-5510-4f38-8216-30c12ab46cc5"
								mask="false"
								optional="false"
								fixedValue="false">
							<from>user/alias</from>
							<to>output/response/name</to>
						</steps>
						<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
								disabled="false"
								id="5ccbdf83-8140-4c5f-848c-eec39f081b3c"
								serviceId="nabu.cms.core.database.node.audit.updateActor"
								resultName="resultae51bbab81a641b081bbd79730b01fc1"
								temporaryMapping="true"
								x="110"
								y="430"
								invocationOrder="0"
								asynchronous="false"
								recache="false">
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="c4e2e82c-d0f7-4538-9b7e-ee02cdd73499"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>input/configuration/connectionId</from>
								<to>connection</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="2640a409-6e81-4b83-a724-491a3ddd27e3"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>auditId</from>
								<to>parameters[0]/id</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="b7d362b6-25f3-4a56-a324-4c453ab72b4c"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>user/id</from>
								<to>parameters[0]/actorId</to>
							</steps>
						</steps>
						<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
								disabled="false"
								id="b8f78ecc-9ee4-4192-b32d-67a70940a1ff"
								serviceId="nabu.cms.core.services.user.generateVerificationCode"
								resultName="result5579ff87c58b4c61b2e162bb8c1e1b31"
								temporaryMapping="true"
								x="63"
								y="197"
								invocationOrder="0"
								asynchronous="false"
								recache="false">
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="ea7c50e4-7e48-4b61-af2c-bc351c251e25"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>input/configuration/connectionId</from>
								<to>connectionId</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="1d4cfbb6-a8ce-4f77-b28c-aba9ce00420f"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>originalUser/aliasTypeId</from>
								<to>aliasTypeId</to>
							</steps>
						</steps>
						<steps xsi:type="be.nabu.libs.services.vm.step.Link"
								disabled="false"
								id="4030d570-3316-4b14-a0f0-d7e025bb8463"
								mask="false"
								optional="false"
								fixedValue="false">
							<from>result5579ff87c58b4c61b2e162bb8c1e1b31/verificationCode</from>
							<to>originalUser/verificationCode</to>
						</steps>
						<steps xsi:type="be.nabu.libs.services.vm.step.Link"
								disabled="false"
								id="e861ba82-81cc-4a8a-87c0-668b0209f164"
								mask="false"
								optional="false"
								fixedValue="false">
							<from>user/id</from>
							<to>output/response/authenticationId</to>
						</steps>
					</steps>
					<steps xsi:type="be.nabu.libs.services.vm.step.Map"
							comment="Update the verification code"
							disabled="false"
							id="b512ebf4-87d8-4f4c-be44-d265aa7881d4">
						<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
								disabled="false"
								id="bdfe2423-5002-4746-b850-6828c8627ec0"
								serviceId="nabu.cms.core.database.user.update"
								resultName="result7542040de0294b65867ce61b53954a0a"
								temporaryMapping="true"
								x="142"
								y="157"
								invocationOrder="0"
								asynchronous="false"
								recache="false">
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="0f792831-a9b7-47f9-b567-e1686818e278"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>input/configuration/connectionId</from>
								<to>connection</to>
							</steps>
							<steps xsi:type="be.nabu.libs.services.vm.step.Link"
									disabled="false"
									id="cd375344-2a46-497a-b06f-c524a480a6da"
									mask="false"
									optional="false"
									fixedValue="false">
								<from>originalUser</from>
								<to>parameters[0]</to>
							</steps>
						</steps>
						<steps xsi:type="be.nabu.libs.services.vm.step.Link"
								disabled="false"
								id="5b9c8d53-b9a2-49a3-9de9-a446d288fb33"
								mask="false"
								optional="false"
								fixedValue="false">
							<from>user</from>
							<to>output/user</to>
						</steps>
					</steps>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Throw"
						description="=&quot;Invalid password entered for: &quot; + user/alias"
						disabled="false"
						id="67e864c4-3502-45b5-92c0-7f2145fb4010"
						code="CMS-AUTH-1"
						message="Invalid password"
						alias="=user/alias"
						realm="=user/realm" xsi:nil="true"/>
			</steps>
			<steps xsi:type="be.nabu.libs.services.vm.step.Catch"
					disabled="false"
					id="5a378ab8-0cef-4cfb-b97b-e0197fc449aa"
					variable="exception">
				<steps xsi:type="be.nabu.libs.services.vm.step.Map"
						disabled="false"
						id="e69b3dc1-ce31-4ccd-a217-29b0bee13169">
					<steps xsi:type="be.nabu.libs.services.vm.step.Invoke"
							disabled="false"
							id="7544cff1-b2ee-4d72-b277-3b9535f04140"
							serviceId="nabu.cms.core.services.node.audit.error"
							resultName="resultf0058a1ba5fc4283b405f086eccb1e80"
							temporaryMapping="true"
							x="33"
							y="78"
							invocationOrder="0"
							asynchronous="false"
							recache="false">
						<steps xsi:type="be.nabu.libs.services.vm.step.Link"
								disabled="false"
								id="011869f5-da36-464c-8171-6ba66434cb62"
								mask="false"
								optional="false"
								fixedValue="false">
							<from>exception</from>
							<to>exception</to>
						</steps>
						<steps xsi:type="be.nabu.libs.services.vm.step.Link"
								disabled="false"
								id="cdae914c-f6a7-4b52-93f2-4515e9969a34"
								mask="false"
								optional="false"
								fixedValue="false">
							<from>input/configuration/connectionId</from>
							<to>connectionId</to>
						</steps>
						<steps xsi:type="be.nabu.libs.services.vm.step.Link"
								disabled="false"
								id="100ef8b4-68da-4631-b25a-bd8dc38b3ebe"
								mask="false"
								optional="false"
								fixedValue="false">
							<from>auditId</from>
							<to>auditId</to>
						</steps>
						<steps xsi:type="be.nabu.libs.services.vm.step.Link"
								disabled="false"
								id="ee535d8e-4465-4a45-b9e5-5b3486c49ed2"
								mask="false"
								optional="false"
								fixedValue="true">
							<from>false</from>
							<to>rethrow</to>
						</steps>
					</steps>
				</steps>
				<steps xsi:type="be.nabu.libs.services.vm.step.Throw"
						disabled="false"
						id="90af9313-d224-4a86-a518-545fb3f00211"
						message="=exception" xsi:nil="true"/>
			</steps>
		</steps>
	</steps>
	<steps xsi:type="be.nabu.libs.services.vm.step.Throw"
			disabled="false"
			id="2aea3a18-b354-4250-a9b1-1d987f244f5f"
			label="!user"
			code="CMS-AUTH-7"
			alias="=input/credentials/name"
			realm="=input/realm" xsi:nil="true"/>
</sequence>